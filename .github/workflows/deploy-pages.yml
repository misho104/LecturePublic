name: Deploy PDFs to GitHub Pages

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags and branches

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create docs directory
        run: mkdir -p docs

      - name: Copy all current PDF files
        run: |
          echo "Copying latest PDF files..."
          find . -type f -name "*.pdf" ! -path "./docs/*" ! -path "./.git/*" -exec cp {} docs/ \;
          echo "Latest PDFs copied:"
          ls -lh docs/

      - name: Process versioned PDFs
        run: |
          echo "Processing versions.json..."
          if [ -f .github/versions.json ]; then
            # Check if versions array is not empty
            version_count=$(jq '.versions | length' .github/versions.json)
            if [ "$version_count" -gt 0 ]; then
              jq -c '.versions[]' .github/versions.json | while read -r version; do
                file=$(echo "$version" | jq -r '.file')
                tag=$(echo "$version" | jq -r '.tag')
                version_name=$(echo "$version" | jq -r '.version')
                
                echo "Fetching $file from tag/commit $tag as version $version_name..."
                
                # Get the file from the specified tag/commit
                git show "$tag:$file" > "docs/$(basename "${file%.*}")-${version_name}.pdf" 2>/dev/null || {
                  echo "Warning: Could not fetch $file from $tag"
                  continue
                }
                
                echo "Created: $(basename "${file%.*}")-${version_name}.pdf"
              done
            else
              echo "No versions defined in versions.json"
            fi
          else
            echo "No versions.json file found, skipping version processing"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          pip install pyyaml jinja2

      - name: Generate HTML index
        run: |
          python .github/scripts/generate_index.py
          echo "HTML index generated"
          cat docs/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
